const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);

// --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ ---
let placedObjects = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

// --- –†–∞–∑–º–µ—Ä—ã –ø–ª–æ—â–∞–¥–∫–∏ ---
let playgroundWidth = 10; // –®–∏—Ä–∏–Ω–∞ –ø–ª–æ—â–∞–¥–∫–∏ –≤ –º–µ—Ç—Ä–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
let playgroundLength = 10; // –î–ª–∏–Ω–∞ –ø–ª–æ—â–∞–¥–∫–∏ –≤ –º–µ—Ç—Ä–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

// --- –§–æ–Ω ---
var skybox = BABYLON.MeshBuilder.CreateBox("cityBox", {size:1000.0}, scene);
var skyboxMaterial = new BABYLON.StandardMaterial("cityBox", scene);
skyboxMaterial.backFaceCulling = false;
skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("textures/citybox/citybox", scene);
skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
skybox.material = skyboxMaterial;

// --- –ö–∞–º–µ—Ä–∞ —Å OrbitControls (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å shed_designer) ---
const camera = new BABYLON.ArcRotateCamera(
    "camera",
    0,           // –ü–æ–≤–æ—Ä–æ—Ç –≤–æ–∫—Ä—É–≥ –æ—Å–∏ Y
    1.3,         // –ù–∞–∫–ª–æ–Ω (–æ–∫–æ–ª–æ 1.57 = —Å—Ç—Ä–æ–≥–æ —Å–≤–µ—Ä—Ö—É)
    15,          // –†–∞–¥–∏—É—Å (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞)
    new BABYLON.Vector3(0, 0, 0),
    scene
);
camera.attachControl(canvas, true);
camera.upperBetaLimit = Math.PI / 2.2;
camera.lowerRadiusLimit = 5;  // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞
camera.upperRadiusLimit = 50; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞

// –ü–æ–∑–≤–æ–ª—è–µ—Ç –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞–º–µ—Ä–æ–π
camera.inertia = 0.7;
camera.wheelPrecision = 100; // –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑—É–º–∞ –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏
camera.panningSensibility = 100; // –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏—è

// --- –°–≤–µ—Ç ---
const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(1, 1, 0), scene);

// --- –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å (playground) ---
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è ground –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ playground
let ground = null;
let groundMesh = null;

BABYLON.SceneLoader.ImportMesh("", "models/", "playground.glb", scene, function (newMeshes) {
    if (!newMeshes || newMeshes.length === 0) return;
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –∏–ª–∏ –ø–µ—Ä–≤—É—é –º–µ—à—É
    const playground = newMeshes[0].parent || newMeshes[0];
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏ playground
    playground.position = new BABYLON.Vector3(0, 0, 0);
    playground.rotationQuaternion = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç –∏–∑ glTF
    playground.scaling = new BABYLON.Vector3(1, 1, 1);
    
    ground = playground;
    groundMesh = newMeshes[0]; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤—É—é –º–µ—à—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
    const statusElement = document.getElementById("playgroundStatus");
    if (statusElement) {
        statusElement.textContent = `–ü–ª–æ—â–∞–¥–∫–∞: ${playgroundWidth}–º √ó ${playgroundLength}–º`;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º HTML-–º–µ—Ç–∫–∏ —Ä–∞–∑–º–µ—Ä–æ–≤
    document.getElementById("widthLabel").textContent = `${playgroundWidth}–º`;
    document.getElementById("lengthLabel").textContent = `${playgroundLength}–º`;
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –ø–ª–æ—â–∞–¥–∫–∏ —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ä–∞–¥–∏)
function createPlayground(width, length) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
    const statusElement = document.getElementById("playgroundStatus");
    if (statusElement) {
        statusElement.textContent = `–ü–ª–æ—â–∞–¥–∫–∞: ${width}–º √ó ${length}–º`;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º HTML-–º–µ—Ç–∫–∏ —Ä–∞–∑–º–µ—Ä–æ–≤
    document.getElementById("widthLabel").textContent = `${width}–º`;
    document.getElementById("lengthLabel").textContent = `${length}–º`;
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å ground, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –µ–≥–æ
    if (ground) {
        ground.scaling = new BABYLON.Vector3(width/10, 1, length/10);
    }
    
    return ground;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ —Å—Ü–µ–Ω—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
function takeScreenshot() {
    // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –≤—Å–ø—ã—à–∫–∏ –ø–µ—Ä–µ–¥ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º
    const flashOverlay = document.createElement('div');
    flashOverlay.style.position = 'fixed';
    flashOverlay.style.top = '0';
    flashOverlay.style.left = '0';
    flashOverlay.style.width = '100%';
    flashOverlay.style.height = '100%';
    flashOverlay.style.backgroundColor = 'white';
    flashOverlay.style.opacity = '0';
    flashOverlay.style.transition = 'opacity 0.2s ease-in-out';
    flashOverlay.style.pointerEvents = 'none';
    flashOverlay.style.zIndex = '9999';
    document.body.appendChild(flashOverlay);
    
    // –î–µ–ª–∞–µ–º –≤—Å–ø—ã—à–∫—É –∏ —Å–∫—Ä—ã–≤–∞–µ–º –µ–µ
    setTimeout(() => {
        flashOverlay.style.opacity = '0.5';
        
        // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç canvas –ø–æ—Å–ª–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ –≤—Å–ø—ã—à–∫–∏
        setTimeout(() => {
            BABYLON.Tools.CreateScreenshot(engine, camera, { precision: 1 }, function(data) {
                // –£–±–∏—Ä–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –≤—Å–ø—ã—à–∫–∏
                flashOverlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(flashOverlay);
                }, 200);
                
                // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const downloadLink = document.createElement('a');
                downloadLink.href = data;
                
                // –°–æ–∑–¥–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
                const date = new Date();
                const fileName = `playground_${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}-${date.getMinutes().toString().padStart(2, '0')}.png`;
                
                downloadLink.download = fileName;
                
                // –≠–º—É–ª–∏—Ä—É–µ–º –∫–ª–∏–∫ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification("–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!", false);
            });
        }, 100);
    }, 50);
}

// --- –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–æ—Ä–º—ã –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ ---
document.addEventListener("DOMContentLoaded", () => {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
    document.getElementById("saveScreenshot").addEventListener("click", takeScreenshot);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
    document.getElementById("playgroundWidth").value = playgroundWidth;
    document.getElementById("playgroundLength").value = playgroundLength;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–æ—â–∞–¥–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const statusElement = document.getElementById("playgroundStatus");
    if (statusElement) {
        statusElement.textContent = `–ü–ª–æ—â–∞–¥–∫–∞: ${playgroundWidth}–º √ó ${playgroundLength}–º`;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ —Ä–∞–∑–º–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    document.getElementById("playgroundWidth").addEventListener("input", (e) => {
        const value = parseFloat(e.target.value) || playgroundWidth;
        document.getElementById("widthLabel").textContent = `${value}–º`;
    });
    
    document.getElementById("playgroundLength").addEventListener("input", (e) => {
        const value = parseFloat(e.target.value) || playgroundLength;
        document.getElementById("lengthLabel").textContent = `${value}–º`;
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
    document.getElementById("applySettings").addEventListener("click", () => {
        const newWidth = parseFloat(document.getElementById("playgroundWidth").value);
        const newLength = parseFloat(document.getElementById("playgroundLength").value);
        
        if (newWidth >= 5 && newWidth <= 50 && newLength >= 5 && newLength <= 50) {
            const oldWidth = playgroundWidth;
            const oldLength = playgroundLength;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–ª–∞–≤–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
            const startTime = Date.now();
            const duration = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            
            const animateResize = function() {
                const elapsedTime = Date.now() - startTime;
                const progress = Math.min(elapsedTime / duration, 1);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
                const easeProgress = easeInOutCubic(progress);
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ä–∞–∑–º–µ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
                const currentWidth = oldWidth + (newWidth - oldWidth) * easeProgress;
                const currentLength = oldLength + (newLength - oldLength) * easeProgress;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã –ø–ª–æ—â–∞–¥–∫–∏
                if (progress < 1) {
                    // –ï—Å–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º mesh
                    if (groundMesh) {
                        groundMesh.scaling.x = currentWidth / oldWidth;
                        groundMesh.scaling.z = currentLength / oldLength;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏
                    document.getElementById("widthLabel").textContent = `${currentWidth.toFixed(1)}–º`;
                    document.getElementById("lengthLabel").textContent = `${currentLength.toFixed(1)}–º`;
                    
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                    requestAnimationFrame(animateResize);
                } else {
                    // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                    playgroundWidth = newWidth;
                    playgroundLength = newLength;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–æ—â–∞–¥–∫—É
                    ground = createPlayground(playgroundWidth, playgroundLength);
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∑–∏—Ü–∏–π –æ–±—ä–µ–∫—Ç–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification("–†–∞–∑–º–µ—Ä—ã –ø–ª–æ—â–∞–¥–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã", false);
                }
            };
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
            function easeInOutCubic(t) {
                return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            animateResize();
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
            showNotification("–†–∞–∑–º–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –æ—Ç 5 –¥–æ 50 –º–µ—Ç—Ä–æ–≤", true);
        }
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞ –≤–∏–¥–∞
    document.getElementById("resetView").addEventListener("click", () => {
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        const targetAlpha = 0; // –¶–µ–ª–µ–≤–æ–π –ø–æ–≤–æ—Ä–æ—Ç –≤–æ–∫—Ä—É–≥ –æ—Å–∏ Y
        const targetBeta = 1.3; // –¶–µ–ª–µ–≤–æ–π –Ω–∞–∫–ª–æ–Ω
        const targetRadius = playgroundWidth > playgroundLength ? 
                           playgroundWidth * 1.5 : playgroundLength * 1.5; // –¶–µ–ª–µ–≤–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
        const targetPosition = BABYLON.Vector3.Zero(); // –¶–µ–ª–µ–≤–∞—è —Ç–æ—á–∫–∞ –∫–∞–º–µ—Ä—ã
        
        // –°–æ–∑–¥–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
        const startTime = Date.now();
        const duration = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        const startAlpha = camera.alpha;
        const startBeta = camera.beta;
        const startRadius = camera.radius;
        const startTarget = camera.target.clone();
        
        // –§—É–Ω–∫—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
        const animateCamera = function() {
            const elapsedTime = Date.now() - startTime;
            const progress = Math.min(elapsedTime / duration, 1);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
            const easeProgress = easeInOutCubic(progress);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–º–µ—Ä—ã —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
            camera.alpha = startAlpha + (targetAlpha - startAlpha) * easeProgress;
            camera.beta = startBeta + (targetBeta - startBeta) * easeProgress;
            camera.radius = startRadius + (targetRadius - startRadius) * easeProgress;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–ª–µ–≤—É—é —Ç–æ—á–∫—É –∫–∞–º–µ—Ä—ã
            const newTarget = new BABYLON.Vector3(
                startTarget.x + (targetPosition.x - startTarget.x) * easeProgress,
                startTarget.y + (targetPosition.y - startTarget.y) * easeProgress,
                startTarget.z + (targetPosition.z - startTarget.z) * easeProgress
            );
            camera.target = newTarget;
            
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
            if (progress < 1) {
                requestAnimationFrame(animateCamera);
            } else {
                // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification("–í–∏–¥ –∫–∞–º–µ—Ä—ã —Å–±—Ä–æ—à–µ–Ω", false);
            }
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        animateCamera();
    });
});

// --- –¶–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ ---
const elementPrices = {
    "0001.glb": 8000,
    "242.glb": 7500,
    "0502.glb": 12000,
    "0519.glb": 11000,
    "3540.glb": 9500,
    "4209.glb": 13000,
    "–ö–∞—Ä–∫–∞—Å –∫–∞—á–µ–ª–µ–π-–±–∞–ª–∞–Ω—Å–∏—Ä–∞ -–¢–∞–π–≥–∞-.stl": 14000,
    "lgd_3.glb": 11000,
    "lgk_11.glb": 6000,
    "lgk_314.glb": 10000,
    "MG0001 2024-09 R2 –ú–æ–¥–µ–ª—å.glb": 25000,
    "MG0001.stl": 20000,
    "msk_105.glb": 4000,
    "msk_201.glb": 15000,
};

let totalPrice = 0;

const modelSizes = {
    "0001.glb": 2,
    "242.glb": 2,
    "0502.glb": 2,
    "0519.glb": 2,
    "3540.glb": 3,
    "4209.glb": 4,
    "–ö–∞—Ä–∫–∞—Å –∫–∞—á–µ–ª–µ–π-–±–∞–ª–∞–Ω—Å–∏—Ä–∞ -–¢–∞–π–≥–∞-.stl": 2.5,
    "lgd_3.glb": 2,
    "lgk_11.glb": 0.1,
    "lgk_314.glb": 2,
    "MG0001 2024-09 R2 –ú–æ–¥–µ–ª—å.glb": 10,
    "MG0001.stl": 10,
    "msk_105.glb": 3,
    "msk_201.glb": 3,
    "201.fbx":3,
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü –æ–±—ä–µ–∫—Ç–∞
function getObjectBounds(object) {
    const boundingInfo = object.getHierarchyBoundingVectors(true);
    const min = boundingInfo.min;
    const max = boundingInfo.max;
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –æ–±—ä–µ–∫—Ç–∞
    const center = new BABYLON.Vector3(
        (min.x + max.x) / 2 + object.position.x,
        0,
        (min.z + max.z) / 2 + object.position.z
    );
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–¥–∏—É—Å (–ø–æ–ª–æ–≤–∏–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞)
    const radius = Math.max(
        (max.x - min.x) / 2,
        (max.z - min.z) / 2
    );
    
    return { center, radius };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–ª–æ—â–∞–¥–∫–∏
// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, —Ç–∞–∫ –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç—Å—è —É–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –≤—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
function isWithinPlayground(object) {
    return true;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –≥—Ä–∞–Ω–∏—Ü –ø–ª–æ—â–∞–¥–∫–∏
// –§—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –≤–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞
let boundaryLines = [];
function highlightPlaygroundBoundary(show) {
    // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω
    return;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞
// –û—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–≤–æ–∑–≤—Ä–∞—Ç–∞
function saveInitialPosition(object) {
    // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
// –û—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
function resetToInitialPosition(object) {
    // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –æ—Ç–∫–ª—é—á–µ–Ω
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—ä–µ–∫—Ç–∞
// –¢–µ–ø–µ—Ä—å –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø—Ä–æ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
function checkAndHighlightObject(object) {
    // –¢–µ–ø–µ—Ä—å –æ–±—ä–µ–∫—Ç –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    updatePositionStatus(true);
    
    // –£–¥–∞–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö –≤ –æ–±—ä–µ–∫—Ç–µ
    if (object) {
        object.hasPositionError = false;
    }
    
    return true;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–∑–∏—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
function updatePositionStatus(withinPlayground) {
    const statusElement = document.getElementById("positionStatus");
    
    if (!statusElement) return;
    
    // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ü–æ–∑–∏—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞", —Ç–∞–∫ –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–±—Ä–∞–Ω–∞
    statusElement.textContent = "–ü–æ–∑–∏—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞";
    statusElement.className = "valid-position";
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ
function checkAllObjectsPositions() {
    for (let object of placedObjects) {
        checkAndHighlightObject(object);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, isWarning = true) {
    const notification = document.getElementById('notification');
    const notificationMessage = document.querySelector('.notification-message');
    
    if (notification && notificationMessage) {
        notificationMessage.textContent = message;
        notification.className = isWarning ? 'notification warning' : 'notification info';
        notification.classList.remove('hidden');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 3000);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
        const closeButton = notification.querySelector('.notification-close');
        if (closeButton) {
            closeButton.onclick = function() {
                notification.classList.add('hidden');
            };
        }
    }
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ ---
document.querySelectorAll(".item").forEach(item => {
    item.addEventListener("dragstart", event => {
        const model = event.target.closest(".item").getAttribute("data-model");
        console.log("Drag started:", model);
        event.dataTransfer.setData("model", model);
    });
});

// --- –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è drop ---
canvas.addEventListener("dragover", event => event.preventDefault());

// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
let nextObjectId = 1;
function generateObjectId() {
    return `object_${nextObjectId++}`;
}

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è drop –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ ---
canvas.addEventListener("drop", event => {
    event.preventDefault();
    const modelName = event.dataTransfer.getData("model");
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ, –∫—É–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "—É—Ä–æ–Ω–∏–ª" –æ–±—ä–µ–∫—Ç
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –ø–æ –ø–ª–æ—â–∞–¥–∫–µ
    const pickResult = scene.pick(
        event.clientX, 
        event.clientY, 
        mesh => groundMesh && (mesh === groundMesh || mesh.isDescendantOf(ground))
    );

    if (modelName) {
        BABYLON.SceneLoader.ImportMesh("", "models/", modelName, scene, function (newMeshes) {
            if (!newMeshes || newMeshes.length === 0) {
                console.error("–û—à–∏–±–∫–∞: –º–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞", modelName);
                return;
            }

            // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—à–µ–π
            const container = new BABYLON.TransformNode(`modelContainer_${modelName}_${generateObjectId()}`, scene);
            // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π id –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
            container.id = generateObjectId();
            newMeshes.forEach(mesh => {
                mesh.parent = container;
            });

            // –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏
            if (modelName === "MG0001 2024-09 R2 –ú–æ–¥–µ–ª—å.glb") {
                container.rotation.x = Math.PI / 2;
            }
            if (modelName === "0519.glb") {
                container.rotation.x = Math.PI / -2;
            }
            if (modelName === "0001.glb") {
                container.rotation.x = Math.PI / -2;
            }

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –ø–æ–∑–∏—Ü–∏—é –±—Ä–æ—Å–∫–∞ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ
            if (pickResult && pickResult.hit && pickResult.pickedPoint) {
                container.position = pickResult.pickedPoint;
            } else {
                // –ï—Å–ª–∏ –ø–ª–æ—â–∞–¥–∫–∞ –Ω–µ –ø–æ–ø–∞–ª–∞ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä, —Å—Ç–∞–≤–∏–º –æ–±—ä–µ–∫—Ç –≤ —Ü–µ–Ω—Ç—Ä –ø–ª–æ—â–∞–¥–∫–∏
                container.position = new BABYLON.Vector3(0, 0, 0);
                showNotification("–û–±—ä–µ–∫—Ç –ø–æ–º–µ—â–µ–Ω –≤ —Ü–µ–Ω—Ç—Ä –ø–ª–æ—â–∞–¥–∫–∏", false);
            }
                
            // –í—ã—á–∏—Å–ª—è–µ–º bounding box
            let boundingVectors = container.getHierarchyBoundingVectors();
            let size = boundingVectors.max.subtract(boundingVectors.min);
            let maxDimension = Math.max(size.x, size.y, size.z);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –º–æ–¥–µ–ª–∏ –∏–∑ —Å–ª–æ–≤–∞—Ä—è
            let standardSize = modelSizes[modelName] || 1;

            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —Å—Ç–∞–ª–∞ —Ä–∞–≤–Ω–∞ standardSize
            let scaleFactor = standardSize / maxDimension;
            container.scaling = new BABYLON.Vector3(scaleFactor, scaleFactor, scaleFactor);

            // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω—å –ø–æ Y=0
            boundingVectors = container.getHierarchyBoundingVectors();
            const minY = boundingVectors.min.y;
            container.position.y -= minY;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
            placedObjects.push(container);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç
            checkAndHighlightObject(container);

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
            const price = elementPrices[modelName] || 0;
            totalPrice += price;
            document.getElementById("totalPrice").textContent = totalPrice.toLocaleString();

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ç–∞–±–ª–∏—Ü—É —Å –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è
            const tableBody = document.querySelector("#elementsTable tbody");
            const row = document.createElement("tr");
            row.innerHTML = `<td>${modelName}</td>
                             <td>${price.toLocaleString()} ‚ÇΩ</td>
                             <td><button class="delete-button" style="cursor:pointer;">üóëÔ∏è</button></td>`;
            tableBody.appendChild(row);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ —Å—Ç—Ä–æ–∫–µ
            row.container = container;
            row.price = price;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
            row.querySelector(".delete-button").addEventListener("click", () => {
                if (row.container) {
                    // –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –º–∞—Å—Å–∏–≤–∞ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
                    const index = placedObjects.indexOf(row.container);
                    if (index > -1) {
                        placedObjects.splice(index, 1);
                    }
                    
                    row.container.dispose();
                }
                totalPrice -= row.price;
                document.getElementById("totalPrice").textContent = totalPrice.toLocaleString();
                row.remove();
                
                // –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã
                checkAllObjectsPositions();
            });
        });
    }
});

// --- –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–ø—Ä–∞–≤—ã–π –∫–ª–∏–∫) ---
canvas.addEventListener("contextmenu", event => event.preventDefault());

// --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è–º–∏ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ ---
let selectedMesh = null;
let isDragging = false;
let isRotating = false;
let dragOffset = BABYLON.Vector3.Zero();
let initialRotationY = 0;
let initialPointerX = 0;

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –∏ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏
scene.onPointerObservable.add(pointerInfo => {
    const event = pointerInfo.event;
    
    if (pointerInfo.type === BABYLON.PointerEventTypes.POINTERDOWN) {
        const pickInfo = pointerInfo.pickInfo;
        if (pickInfo && pickInfo.hit && pickInfo.pickedMesh) {
            // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ playground –∏–ª–∏ –ø–æ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–º –æ–±—ä–µ–∫—Ç–∞–º ‚Äì –Ω–µ –≤—ã–±–∏—Ä–∞–µ–º –æ–±—ä–µ–∫—Ç
            if (groundMesh && (pickInfo.pickedMesh === groundMesh || pickInfo.pickedMesh.isDescendantOf(ground))) {
                selectedMesh = null;
                return;
            }
            // –í—ã–±–∏—Ä–∞–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–±—ä–µ–∫—Ç–∞
            selectedMesh = pickInfo.pickedMesh.parent || pickInfo.pickedMesh;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –¥–≤–∏–∂–µ–Ω–∏—è
            saveInitialPosition(selectedMesh);
            
            // –û—Ç–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å/–≤—Ä–∞—â–∞—Ç—å –æ–±—ä–µ–∫—Ç
            camera.detachControl(canvas);

            // –õ–µ–≤—ã–π –∫–ª–∏–∫ ‚Äì –Ω–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            if (event.button === 0) {
                isDragging = true;
                dragOffset = selectedMesh.position.subtract(pickInfo.pickedPoint);
            }
            // –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ ‚Äì –Ω–∞—á–∏–Ω–∞–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ
            else if (event.button === 2) {
                isRotating = true;
                initialRotationY = selectedMesh.rotation.y;
                initialPointerX = event.clientX;
            }
        }
    }
    else if (pointerInfo.type === BABYLON.PointerEventTypes.POINTERMOVE) {
        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
        if (isDragging && selectedMesh) {
            // –í—ã–±–∏—Ä–∞–µ–º —Ç–æ—á–∫—É –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ playground (—É—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã)
            const pickResult = scene.pick(
                scene.pointerX,
                scene.pointerY,
                mesh => groundMesh && (mesh === groundMesh || mesh.isDescendantOf(ground))
            );
            if (pickResult && pickResult.hit && pickResult.pickedPoint) {
                let newPos = pickResult.pickedPoint.add(dragOffset);
                newPos.y = 0;
                selectedMesh.position = newPos;
                
                // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏ –æ–±—ä–µ–∫—Ç–∞ –ø–æ Y=0
                let boundingVectors = selectedMesh.getHierarchyBoundingVectors();
                const minY = boundingVectors.min.y;
                selectedMesh.position.y -= minY;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏
                checkAndHighlightObject(selectedMesh);
            }
        }
        // –í—Ä–∞—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
        else if (isRotating && selectedMesh) {
            const deltaX = event.clientX - initialPointerX;
            selectedMesh.rotation.y = initialRotationY + deltaX * 0.01;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç –ø—Ä–∏ –≤—Ä–∞—â–µ–Ω–∏–∏
            checkAndHighlightObject(selectedMesh);
        }
    }
else if (pointerInfo.type === BABYLON.PointerEventTypes.POINTERUP) {
        // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ/–≤—Ä–∞—â–µ–Ω–∏–µ
        if (isDragging || isRotating) {
            camera.attachControl(canvas, true);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∏ –∞–≤—Ç–æ–≤–æ–∑–≤—Ä–∞—Ç —É–¥–∞–ª–µ–Ω—ã
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
            checkAllObjectsPositions();
        }
        isDragging = false;
        isRotating = false;
        selectedMesh = null;
    }
});

engine.runRenderLoop(() => scene.render());
window.addEventListener("resize", () => engine.resize());