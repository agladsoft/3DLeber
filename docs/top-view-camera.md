# Работа камеры в режиме вида сверху

## Обзор

В режиме вида сверху камера переключается на ортографическую проекцию и позволяет пользователю смотреть на площадку строго сверху вниз. Этот режим предназначен для точного позиционирования объектов на площадке.

## Основные компоненты

### 1. Переключение режима (toggleTopView)

Функция `toggleTopView` в `cameraManager.js`:
- Сохраняет текущее состояние камеры для возврата
- Вычисляет оптимальную высоту камеры на основе размеров площадки
- Анимирует переход камеры в позицию сверху
- Отключает стандартные OrbitControls
- Активирует специальный контроллер для вида сверху

### 2. Позиционирование камеры

```javascript
// Вычисление высоты камеры
const diagonal = Math.sqrt(width * width + length * length);
const targetHeight = diagonal * TOP_VIEW_SETTINGS.heightMultiplier; // 1.1 по умолчанию

// Позиция камеры для вида сверху
camera.position.set(0, targetHeight, 0.1); // Небольшое смещение по Z для лучшего обзора
camera.lookAt(0, 0, 0); // Смотрит на центр сцены
```

### 3. Контроллер вида сверху (topViewController.js)

Специальный контроллер управления камерой, который:
- Использует **правую кнопку мыши** для перемещения камеры
- Поддерживает масштабирование колесиком мыши
- Ограничивает движение камеры только в горизонтальной плоскости

#### Управление:
- **Правая кнопка мыши + перетаскивание** - перемещение камеры по площадке
- **Колесико мыши** - масштабирование (приближение/отдаление)

#### Настройки из config.js:
```javascript
TOP_VIEW_SETTINGS: {
    panSpeed: 0.7,              // Скорость перемещения при перетаскивании
    zoomSpeed: 0.5,             // Скорость масштабирования
    minZoom: 0.2,               // Минимальный уровень приближения
    maxZoom: 3.0,               // Максимальный уровень приближения
    heightMultiplier: 1.1       // Множитель высоты камеры
}
```

### 4. Особенности реализации

1. **Отключение OrbitControls**: При активации вида сверху стандартные контролы полностью отключаются (`controls.enabled = false`)

2. **Фиксация камеры**: Камера жестко фиксируется над площадкой и может двигаться только в плоскости XZ

3. **Предотвращение конфликтов**: Флаг `objectBeingDragged` предотвращает перемещение камеры во время drag&drop объектов

4. **Возврат к обычному виду**: При выключении режима камера анимированно возвращается в сохраненное положение

### 5. Анимация перехода

Используется функция `animateCameraMove` с кубической интерполяцией для плавного перехода между режимами:
```javascript
function easeInOutCubic(t) {
    return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
}
```

## Важные моменты

1. **Сетка удалена**: В текущей версии размерная сетка не отображается, но функционал вида сверху полностью сохранен

2. **Правая кнопка мыши**: Важно, что для перемещения используется именно правая кнопка, чтобы не конфликтовать с выделением объектов

3. **Высота камеры**: Автоматически подстраивается под размер площадки для оптимального обзора

4. **Сохранение состояния**: Режим корректно сохраняет и восстанавливает предыдущее положение камеры

## Файлы реализации

- `/js/scene/cameraManager.js` - основная логика переключения режима
- `/js/scene/topViewController.js` - контроллер управления камерой в режиме вида сверху
- `/js/config.js` - настройки режима вида сверху
- `/js/ui/controlHandlers.js` - обработчик кнопки переключения режима
